<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <title>Panader√≠a Artesanal - Admin</title>
</head>
<body class="bg-stone-50 text-stone-800">
    <!-- Header / Navigation -->
    <header class="bg-white shadow-sm sticky top-0 z-50">
        <nav class="container mx-auto px-6 py-4">
            <div class="flex justify-between items-center">
                <a href="#" class="flex items-center gap-3">
                    <img src="https://www.esperanza.mx/assets/images/logo/logo_50_anios.png" alt="Logo" class="h-12">
                    <span class="text-2xl font-light tracking-wide">Panader√≠a - Admin</span>
                </a>
                <ul class="flex gap-8 list-none items-center">
                    <li><a class="text-stone-600 hover:text-stone-900 transition-colors" href="#inicio">Inicio</a></li>
                    <li><a class="text-stone-600 hover:text-stone-900 transition-colors" href="#productos">Productos</a></li>
                    <li><a class="text-stone-600 hover:text-stone-900 transition-colors" href="#nosotros">Nosotros</a></li>
                    <li><a class="text-stone-600 hover:text-stone-900 transition-colors" href="#contacto">Gesti√≥n</a></li>
                    <li>
                        <span id="username-display" class="text-stone-600 font-light"></span>
                    </li>
                    <li>
                        <button id="logoutBtn" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors text-sm">
                            Cerrar sesi√≥n
                        </button>
                    </li>
                </ul>
            </div>
        </nav>
    </header>

    <!-- Hero Section -->
    <section id="inicio" class="h-screen flex items-center justify-center bg-gradient-to-br from-amber-50 to-stone-100">
        <div class="text-center px-6 max-w-3xl">
            <h1 class="text-7xl font-light mb-6 tracking-tight">Panel de Administraci√≥n</h1>
            <p class="text-2xl text-stone-600 mb-8 font-light">Gestiona tus productos f√°cilmente</p>
            <a href="#productos" class="inline-block px-8 py-3 bg-stone-800 text-white rounded-full hover:bg-stone-700 transition-colors">Ver Productos</a>
        </div>
    </section>

    <!-- Productos Section -->
    <section id="productos" class="container mx-auto px-6 py-20">
        <h2 class="text-4xl font-light text-center mb-16">Gesti√≥n de Productos</h2>
        
        <div id="productos-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
            <!-- Los productos se cargar√°n din√°micamente aqu√≠ -->
        </div>
    </section>

    <!-- Nosotros Section -->
    <section id="nosotros" class="bg-stone-800 text-white py-20">
        <div class="container mx-auto px-6">
            <div class="max-w-3xl mx-auto text-center">
                <h2 class="text-4xl font-light mb-8">Nuestra Historia</h2>
                <p class="text-lg font-light leading-relaxed mb-6">
                    Desde 1975, hemos dedicado nuestra vida al arte del pan. Cada pieza se elabora con ingredientes seleccionados y t√©cnicas tradicionales transmitidas de generaci√≥n en generaci√≥n.
                </p>
                <p class="text-lg font-light leading-relaxed">
                    Nuestro compromiso es ofrecer productos frescos, naturales y deliciosos que lleven sabor y tradici√≥n a tu mesa cada d√≠a.
                </p>
            </div>
        </div>
    </section>

    <!-- Contacto Section -->
    <section id="contacto" class="container mx-auto px-6 py-20">
        <h2 class="text-4xl font-light text-center mb-16">Gesti√≥n de Inventario</h2>
        
        <div class="grid md:grid-cols-2 gap-12 max-w-5xl mx-auto">
            <!-- Informaci√≥n de contacto -->
            <div class="space-y-6">
                <div>
                    <h3 class="text-xl font-light mb-2">Direcci√≥n</h3>
                    <p class="text-stone-600">Av. Principal #123, Colonia Centro<br>Ciudad, Estado, CP 00000</p>
                </div>
                <div>
                    <h3 class="text-xl font-light mb-2">Horario</h3>
                    <p class="text-stone-600">Lunes a S√°bado: 7:00 AM - 8:00 PM<br>Domingo: 8:00 AM - 3:00 PM</p>
                </div>
                <div>
                    <h3 class="text-xl font-light mb-2">Contacto</h3>
                    <p class="text-stone-600">Tel: (55) 1234-5678<br>Email: info@panaderia.com</p>
                </div>
                <div class="bg-blue-50 p-6 rounded-lg border border-blue-200">
                    <h3 class="text-xl font-light mb-2 text-blue-900">üìä Panel de Administrador</h3>
                    <p class="text-blue-700 text-sm">Desde aqu√≠ puedes agregar, editar y eliminar productos del inventario.</p>
                </div>
            </div>

            <!-- Formulario para agregar panes -->
            <div class="bg-white rounded-lg shadow-sm p-8">
                <h3 id="form-titulo" class="text-2xl font-light mb-6 text-center">Agregar Nuevo Pan</h3>
                
                <!-- Mensaje de respuesta -->
                <div id="mensaje" class="mb-4 p-3 rounded-lg hidden"></div>
                
                <form id="agregarPanForm" class="space-y-4">
                    <input type="hidden" id="producto-id" value="">
                    
                    <div>
                        <label for="nombre" class="block text-sm font-light mb-2 text-stone-700">Nombre del Pan</label>
                        <input 
                            type="text" 
                            id="nombre" 
                            name="nombre" 
                            required
                            placeholder="Ej: Pan Integral"
                            class="w-full px-4 py-3 border border-stone-300 rounded-lg focus:outline-none focus:border-stone-600 transition-colors">
                    </div>
                    
                    <div>
                        <label for="descripcion" class="block text-sm font-light mb-2 text-stone-700">Descripci√≥n</label>
                        <textarea 
                            id="descripcion" 
                            name="descripcion" 
                            rows="3"
                            placeholder="Describe el pan..."
                            class="w-full px-4 py-3 border border-stone-300 rounded-lg focus:outline-none focus:border-stone-600 transition-colors"></textarea>
                    </div>
                    
                    <div>
                        <label for="precio" class="block text-sm font-light mb-2 text-stone-700">Precio</label>
                        <input 
                            type="number" 
                            id="precio" 
                            name="precio" 
                            step="0.01"
                            min="0"
                            required
                            placeholder="45.00"
                            class="w-full px-4 py-3 border border-stone-300 rounded-lg focus:outline-none focus:border-stone-600 transition-colors">
                    </div>

                    <div>
                        <label for="cantidad" class="block text-sm font-light mb-2 text-stone-700">Cantidad Disponible</label>
                        <input 
                            type="number" 
                            id="cantidad" 
                            name="cantidad" 
                            min="0"
                            required
                            placeholder="100"
                            class="w-full px-4 py-3 border border-stone-300 rounded-lg focus:outline-none focus:border-stone-600 transition-colors">
                    </div>
                    
                    <div>
                        <label for="imagen_url" class="block text-sm font-light mb-2 text-stone-700">URL de la Imagen</label>
                        <input 
                            type="url" 
                            id="imagen_url" 
                            name="imagen_url" 
                            placeholder="https://ejemplo.com/imagen.jpg"
                            class="w-full px-4 py-3 border border-stone-300 rounded-lg focus:outline-none focus:border-stone-600 transition-colors">
                        <p class="text-xs text-stone-500 mt-1">Opcional: URL de la imagen del producto</p>
                    </div>
                    
                    <div class="flex gap-2">
                        <button 
                            type="submit" 
                            id="agregarBtn"
                            class="flex-1 px-8 py-3 bg-stone-800 text-white rounded-lg hover:bg-stone-700 transition-colors font-light">
                            Agregar Pan
                        </button>
                        
                        <button 
                            type="button" 
                            id="cancelarBtn"
                            class="hidden px-8 py-3 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors font-light">
                            Cancelar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="bg-stone-900 text-stone-400 py-8">
        <div class="container mx-auto px-6 text-center">
            <p class="font-light">&copy; 2025 Panader√≠a Artesanal. Todos los derechos reservados.</p>
        </div>
    </footer>

    <script>
        let isAdmin = false;

        // Verificar autenticaci√≥n y obtener datos del usuario al cargar la p√°gina
        async function verificarAuth() {
            try {
                const response = await fetch('/perfil');
                
                if (!response.ok) {
                    // Si no est√° autenticado, redirigir al login
                    window.location.href = '/';
                    return;
                }
                
                const data = await response.json();
                isAdmin = data.isAdmin;
                
                // Mostrar nombre de usuario en el header
                document.getElementById('username-display').textContent = `Hola, ${data.usuario}`;
                
            } catch (error) {
                console.error('Error:', error);
                window.location.href = '/';
            }
        }

        // Funci√≥n para editar un producto
        function editarProducto(id, nombre, descripcion, precio, cantidad, imagen_url) {
            document.getElementById('form-titulo').textContent = 'Editar Pan';
            
            // Llenar campos con datos actuales
            document.getElementById('producto-id').value = id;
            document.getElementById('nombre').value = nombre;
            document.getElementById('descripcion').value = descripcion || '';
            document.getElementById('precio').value = precio;
            document.getElementById('cantidad').value = cantidad;
            document.getElementById('imagen_url').value = imagen_url || '';
            
            // Cambiar texto del bot√≥n
            document.getElementById('agregarBtn').textContent = 'Actualizar Pan';
            
            // Mostrar bot√≥n cancelar
            document.getElementById('cancelarBtn').classList.remove('hidden');
            
            // Scroll al formulario
            document.getElementById('contacto').scrollIntoView({ behavior: 'smooth' });
        }

        // Funci√≥n para cancelar edici√≥n
        document.getElementById('cancelarBtn').addEventListener('click', function() {
            cancelarEdicion();
        });

        function cancelarEdicion() {
            // Limpiar formulario
            document.getElementById('agregarPanForm').reset();
            document.getElementById('producto-id').value = '';
            
            // Restaurar t√≠tulo
            document.getElementById('form-titulo').textContent = 'Agregar Nuevo Pan';
            
            // Restaurar bot√≥n
            document.getElementById('agregarBtn').textContent = 'Agregar Pan';
            
            // Ocultar bot√≥n cancelar
            document.getElementById('cancelarBtn').classList.add('hidden');
            
            // Ocultar mensaje
            document.getElementById('mensaje').classList.add('hidden');
        }

        // Funci√≥n para eliminar un producto
        async function eliminarProducto(id, nombre) {
            if (!confirm(`¬øEst√°s seguro de eliminar "${nombre}"?`)) {
                return;
            }

            try {
                const response = await fetch(`/api/productos/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();

                if (response.ok) {
                    alert(data.mensaje || 'Producto eliminado correctamente');
                    await cargarProductos();
                } else {
                    alert(data.error || 'Error al eliminar el producto');
                }

            } catch (error) {
                console.error('Error:', error);
                alert('Error al conectar con el servidor');
            }
        }

        // Funci√≥n para cargar productos desde la base de datos
        async function cargarProductos() {
            try {
                const response = await fetch('/api/productos');
                
                if (!response.ok) {
                    throw new Error('Error al cargar productos');
                }
                
                const productos = await response.json();
                const container = document.getElementById('productos-container');
                
                container.innerHTML = '';
                
                productos.forEach(producto => {
                    const article = document.createElement('article');
                    article.className = 'bg-white rounded-lg overflow-hidden shadow-sm hover:shadow-xl transition-shadow';
                    
                    const cantidadDisponible = producto.cantidad || 0;
                    const agotado = cantidadDisponible <= 0;
                    
                    article.innerHTML = `
                        <div class="aspect-square overflow-hidden bg-stone-100 relative">
                            <img src="${producto.imagen_url || 'https://via.placeholder.com/400?text=Sin+Imagen'}" 
                                 alt="${producto.nombre}" 
                                 class="w-full h-full object-cover hover:scale-105 transition-transform duration-500 ${agotado ? 'opacity-50' : ''}"
                                 onerror="this.src='https://via.placeholder.com/400?text=Sin+Imagen'">
                            ${agotado ? '<div class="absolute inset-0 flex items-center justify-center bg-black/50"><span class="text-white text-2xl font-bold">AGOTADO</span></div>' : ''}
                        </div>
                        <div class="p-6">
                            <h3 class="text-2xl font-light mb-2">${producto.nombre}</h3>
                            <p class="text-stone-600 mb-2">${producto.descripcion || 'Sin descripci√≥n disponible'}</p>
                            <p class="text-sm ${agotado ? 'text-red-600 font-semibold' : 'text-green-600'} mb-4">
                                ${agotado ? 'Sin stock' : `Disponible: ${cantidadDisponible} unidades`}
                            </p>
                            <div class="flex justify-between items-center mb-4">
                                <p class="text-xl font-light">$${parseFloat(producto.precio).toFixed(2)}</p>
                            </div>
                            
                            ${isAdmin ? `
                                <div class="flex gap-2">
                                    <button 
                                        onclick='editarProducto(${producto.id}, "${producto.nombre.replace(/'/g, "\\'")}", "${(producto.descripcion || '').replace(/'/g, "\\'")}", ${producto.precio}, ${cantidadDisponible}, "${producto.imagen_url || ''}")' 
                                        class="flex-1 px-4 py-2 bg-blue-600 text-white text-sm rounded-lg hover:bg-blue-700 transition-colors">
                                        ‚úèÔ∏è Editar
                                    </button>
                                    <button 
                                        onclick="eliminarProducto(${producto.id}, '${producto.nombre.replace(/'/g, "\\'")}')" 
                                        class="flex-1 px-4 py-2 bg-red-600 text-white text-sm rounded-lg hover:bg-red-700 transition-colors">
                                        üóëÔ∏è Eliminar
                                    </button>
                                </div>
                            ` : ''}
                        </div>
                    `;
                    
                    container.appendChild(article);
                });
                
                if (productos.length === 0) {
                    container.innerHTML = '<p class="text-center text-stone-600 col-span-full text-lg">No hay productos disponibles en este momento.</p>';
                }
                
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('productos-container').innerHTML = 
                    '<p class="text-center text-red-600 col-span-full text-lg">Error al cargar los productos. Intenta recargar la p√°gina.</p>';
            }
        }
        
        // Funci√≥n para cerrar sesi√≥n
        document.getElementById('logoutBtn').addEventListener('click', async function(event) {
            event.preventDefault();
            
            // Confirmar antes de cerrar sesi√≥n
            if (!confirm('¬øEst√°s seguro de que deseas cerrar sesi√≥n?')) {
                return;
            }
            
            try {
                const response = await fetch('/logout', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    // Mostrar mensaje y redirigir
                    alert(data.mensaje || 'Sesi√≥n cerrada correctamente');
                    window.location.href = '/';
                } else {
                    alert('Error al cerrar sesi√≥n');
                }
                
            } catch (error) {
                console.error('Error:', error);
                alert('Error al conectar con el servidor');
            }
        });
        
        // Cargar datos al iniciar la p√°gina
        document.addEventListener('DOMContentLoaded', async function() {
            await verificarAuth();
            await cargarProductos();
        });
        
        // Manejo del formulario para agregar/editar pan
        document.getElementById('agregarPanForm').addEventListener('submit', async function(event) {
            event.preventDefault();
            
            const productoId = document.getElementById('producto-id').value;
            const nombre = document.getElementById('nombre').value;
            const descripcion = document.getElementById('descripcion').value;
            const precio = document.getElementById('precio').value;
            const cantidad = document.getElementById('cantidad').value;
            const imagen_url = document.getElementById('imagen_url').value;
            const agregarBtn = document.getElementById('agregarBtn');
            const mensajeDiv = document.getElementById('mensaje');
            
            // Determinar si es edici√≥n o creaci√≥n
            const isEditing = productoId !== '';
            const url = isEditing ? `/api/productos/${productoId}` : '/api/productos';
            const method = isEditing ? 'PUT' : 'POST';
            
            // Deshabilitar bot√≥n
            agregarBtn.disabled = true;
            agregarBtn.textContent = isEditing ? 'Actualizando...' : 'Agregando...';
            agregarBtn.classList.add('opacity-50', 'cursor-not-allowed');
            
            try {
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        nombre: nombre, 
                        descripcion: descripcion, 
                        precio: parseFloat(precio),
                        cantidad: parseInt(cantidad),
                        imagen_url: imagen_url 
                    })
                });
                
                const data = await response.json();
                
                // Mostrar mensaje
                mensajeDiv.classList.remove('hidden');
                
                if (response.ok) {
                    // √âxito
                    mensajeDiv.className = 'mb-4 p-3 rounded-lg bg-green-100 text-green-800 border border-green-300';
                    mensajeDiv.textContent = data.mensaje || (isEditing ? 'Pan actualizado correctamente' : 'Pan agregado correctamente');
                    
                    // Limpiar formulario
                    cancelarEdicion();
                    
                    // Recargar productos
                    await cargarProductos();
                    
                    // Ocultar mensaje despu√©s de 3 segundos
                    setTimeout(() => {
                        mensajeDiv.classList.add('hidden');
                    }, 3000);
                    
                } else {
                    // Error
                    mensajeDiv.className = 'mb-4 p-3 rounded-lg bg-red-100 text-red-800 border border-red-300';
                    mensajeDiv.textContent = data.error || 'Error al procesar la solicitud';
                }
                
            } catch (error) {
                console.error('Error:', error);
                mensajeDiv.classList.remove('hidden');
                mensajeDiv.className = 'mb-4 p-3 rounded-lg bg-red-100 text-red-800 border border-red-300';
                mensajeDiv.textContent = 'Error al conectar con el servidor';
            } finally {
                // Rehabilitar bot√≥n
                agregarBtn.disabled = false;
                agregarBtn.textContent = isEditing ? 'Actualizar Pan' : 'Agregar Pan';
                agregarBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        });
    </script>
</body>
</html>